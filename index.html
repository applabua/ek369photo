<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Indigo Remove BG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        background-color: #1a1b2e;
        color: white;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 20px;
    }
    h1 {
        color: #8faaff;
    }
    .upload-box {
        background: #26284a;
        border: 2px dashed #8faaff;
        padding: 20px;
        border-radius: 12px;
        margin: 20px auto;
        width: 90%;
        max-width: 400px;
        cursor: pointer;
    }
    input[type="file"] {
        display: none;
    }
    button {
        background: #8faaff;
        color: #1a1b2e;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        margin-top: 15px;
        cursor: pointer;
        font-size: 16px;
    }
    button:hover {
        background: #aabaff;
    }
    canvas {
        margin-top: 20px;
        max-width: 100%;
        border-radius: 12px;
    }
</style>
</head>
<body>
<h1>Indigo Remove BG</h1>
<label class="upload-box">
    <strong>Нажми или перетащи картинку сюда</strong>
    <input type="file" id="fileInput" accept="image/*">
</label>
<div>
    <button id="bgWhite">Белый фон</button>
    <button id="bgTransparent">Прозрачный фон</button>
</div>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.9.1"></script>
<script>
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let originalImage = null;
let mask = null;

async function loadModel() {
    window.model = await window.transformers.pipeline('image-segmentation', 'Xenova/deeplabv3_resnet50');
}
loadModel();

fileInput.addEventListener('change', async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    originalImage = img;
    canvas.width = img.width;
    canvas.height = img.height;
    
    ctx.drawImage(img, 0, 0);

    const result = await window.model(img);
    mask = result[0].mask; // это маска объекта

    applyMask('white');
});

function applyMask(bgColor) {
    if (!originalImage || !mask) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(mask, 0, 0, canvas.width, canvas.height);
    const maskData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = bgColor === 'transparent' ? 'rgba(0,0,0,0)' : bgColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.globalCompositeOperation = 'destination-over';
    ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

    ctx.globalCompositeOperation = 'destination-in';
    ctx.putImageData(maskData, 0, 0);

    ctx.globalCompositeOperation = 'source-over';
}

document.getElementById('bgWhite').onclick = () => applyMask('white');
document.getElementById('bgTransparent').onclick = () => applyMask('transparent');
</script>
</body>
</html>
